@page "/pagos/tilopay"
@namespace PasarelaPago.Client.Pages.PagosTilopay
@using MudBlazor
@using System.Collections.Generic

<MudGrid Justify="Justify.SpaceAround">
  <MudItem xs="12" sm="12" md="12" lg="6" xl="6" xxl="6">
    <MudCard>
      <MudCardContent Class="grow">
        <div id="payFormTilopay" class="payFormTilopay form-reset">
            <MudGrid Justify="Justify.Center">
              <MudItem>
                <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-2" Color="Color.Info">
                  Pago de servicios
                </MudText>

                <MudCard Class="mb-3" Hidden="true">
                  <MudCardContent>
                    <MudText Typo="Typo.subtitle1" Bold Class="mb-2">Método de pago</MudText>
                    <MudAlert Severity="Severity.Info" Dense>
                      Tarjeta (asignado automáticamente por el SDK)
                    </MudAlert>

                    <!-- Hidden para el SDK -->
                    <input type="hidden"
                           id="tlpy_payment_method"
                           name="tlpy_payment_method"
                           value="@SelectedPaymentMethod" />
                  </MudCardContent>
                </MudCard>

                  <MudCard Class="mb-2">
                    <MudCardContent Class="py-1 px-3">
                      <MudText Typo="Typo.subtitle1" Bold Class="mb-1">Datos de la tarjeta</MudText>

                      <MudGrid Spacing="3">
                        <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                          <MudStack Class="cc-wrapper" Style="position:relative;">
                            <MudTextField T="string"
                                          Label="Número de tarjeta"
                                          Id="tlpy_cc_number"
                                          @bind-Value="CardNumber"
                                          Immediate
                                          MaxLength="@CardNumberMaxChars"
                                          FullWidth Dense Margin="Margin.Dense"
                                          Variant="Variant.Outlined"
                                          InputType="InputType.Telephone"
                                          Validation="ValidateCardNumber"
                                          InputClass="cc-input-pad"
                                          InputAttributes="@(new Dictionary<string, object> {
                                            ["id"] = "tlpy_cc_number",
                                            ["name"] = "cc_number",
                                            ["inputmode"] = "numeric",
                                            ["pattern"] = "[0-9]*", 
                                            ["autocomplete"] = "cc-number"
                                          })" />

                            <MudStack Row="true"
                                      AlignItems="AlignItems.Center"
                                      Spacing="1"
                                      Class="cc-logos"
                                      Style="position:absolute; right:10px; top:50%; transform:translateY(-50%); pointer-events:none;">
                              @if (HasBrandLogo)
                              {
                                <MudImage Src="@BrandLogoSrc"
                                          Alt="@CardBrand"
                                          Class="cc-logo active"
                                          Style="height:24px" />
                              }
                            </MudStack>
                          </MudStack>
                        </MudItem>

                        <MudItem xs="3" sm="3" md="3" lg="3" xl="3" xxl="3">
                          <MudTextField T="string"
                                        Id="tlpy_cc_expiration_date"
                                        Label="Fecha vencimiento"
                                        Placeholder="MM/YY"
                                        @bind-Value="Expiry"
                                        Immediate MaxLength="5"
                                        FullWidth Dense Margin="Margin.Dense"
                                        Variant="Variant.Outlined"
                                        InputType="InputType.Telephone"
                                        Validation="ValidateExpiry"
                                        InputAttributes="@(new Dictionary<string, object> {
                                          ["name"] = "tlpy_cc_expiration_date",
                                          ["autocomplete"] = "cc-exp"
                                        })" />
                        </MudItem>

                        <MudItem xs="3" sm="3" md="3" lg="3" xl="3" xxl="3">
                          <MudTextField T="string"
                                        Id="tlpy_cvv"
                                        Label="@(CardBrand == "amex" ? "Código de seguridad (CID)" : "Código verificación (CVV)")"
                                        Placeholder="@(CardBrand == "amex" ? "4 dígitos" : "3 dígitos")"
                                        @bind-Value="CVV"
                                        Immediate
                                        MaxLength="@CvvMaxLen"
                                        FullWidth Dense Margin="Margin.Dense"
                                        Variant="Variant.Outlined"
                                        InputType="InputType.Telephone"
                                        Validation="ValidateCVV"
                                        InputAttributes="@(new Dictionary<string, object> {
                                          ["name"] = "tlpy_cvv",
                                          ["autocomplete"] = "cc-csc",
                                          ["inputmode"] = "numeric",
                                          ["pattern"] = "[0-9]*", 
                                        })" />
                        </MudItem>
                      </MudGrid>
                    </MudCardContent>
                  </MudCard>
                

                <!-- Datos del propietario -->
                <MudCard Class="mb-2">
                  <MudCardContent>
                    <MudText Typo="Typo.subtitle1" Bold Class="mb-2">Datos del propietario</MudText>

                    <MudGrid Spacing="3">
                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudTextField T="string"
                                      Label="Nombre"
                                      Placeholder="Juan"
                                      @bind-Value="BillToFirstName"
                                      ReadOnly="@OwnerReadOnly"
                                      FullWidth Dense Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      InputAttributes="@(new Dictionary<string, object> {
                                        ["id"] = "billToFirstName",
                                        ["name"] = "billToFirstName"
                                      })" />
                      </MudItem>

                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudTextField T="string"
                                      Label="Apellidos"
                                      Placeholder="Perez Cedeño"
                                      @bind-Value="BillToLastName"
                                      ReadOnly="@OwnerReadOnly"
                                      FullWidth Dense Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      InputAttributes="@(new Dictionary<string, object> {
                                        ["id"] = "billToLastName",
                                        ["name"] = "billToLastName"
                                      })" />
                      </MudItem>

                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudTextField T="string"
                                      Label="Cédula"
                                      Placeholder="Solo números"
                                      @bind-Value="CustomerId"
                                      ReadOnly="@OwnerReadOnly"
                                      FullWidth Dense Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Telephone"
                                      InputAttributes="CustomerIdInputAttrs" />
                      </MudItem>

                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudTextField T="string"
                                      Label="Teléfono"
                                      Placeholder="8888-8888"
                                      @bind-Value="BillToTelephone"
                                      ReadOnly="@OwnerReadOnly"
                                      FullWidth Dense Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Telephone"
                                      InputAttributes="BillToTelephoneInputAttrs" />
                      </MudItem>

                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudTextField T="string"
                                      Label="Correo electrónico"
                                      Placeholder="correo@dominio.com"
                                      @bind-Value="BillToEmail"
                                      FullWidth Dense Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      InputAttributes="@(new Dictionary<string, object> {
                                        ["id"] = "billToEmail",
                                        ["name"] = "billToEmail",
                                        ["type"] = "email"
                                      })" />
                      </MudItem>
                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                      </MudItem>

                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudSelect T="string"
                                   Label="País"
                                   @bind-Value="BillToCountry"
                                   Dense FullWidth Margin="Margin.Normal"
                                   Variant="Variant.Outlined"
                                   InputAttributes="CountryAttrs">
                                    <MudSelectItem T="string" Value="@("CR")">Costa Rica</MudSelectItem> 
                                    <MudSelectItem T="string" Value="@("PA")">Panamá</MudSelectItem> 
                                    <MudSelectItem T="string" Value="@("CO")">Colombia</MudSelectItem>
                        </MudSelect>
                      </MudItem>

                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudTextField T="string"
                                      Label="Código postal"
                                      Placeholder="@ZipPlaceholder"
                                      @bind-Value="BillToZipPostCode"
                                      Immediate MaxLength="10"
                                      FullWidth Dense Margin="Margin.Normal"
                                      Variant="Variant.Outlined"
                                      InputType="InputType.Telephone"
                                      Validation="ValidateZip"
                                      InputAttributes="ZipAttrs" />
                      </MudItem>

                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudTextField T="string"
                                      Label="Ciudad"
                                      Placeholder="Ej. SJO"
                                      @bind-Value="BillToCity"
                                      Immediate
                                      FullWidth Dense Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      Validation="ValidateCity"
                                      InputAttributes="CityAttrs" />
                      </MudItem>

                      <MudItem xs="6" sm="6" md="6" lg="6" xl="6" xxl="6">
                        <MudTextField T="string"
                                      Label="Estado/Provincia"
                                      Placeholder="Ej. SJO"
                                      @bind-Value="BillToState"
                                      Immediate
                                      FullWidth Dense Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      Validation="ValidateState"
                                      InputAttributes="StateAttrs" />
                      </MudItem>

                      <MudItem xs="12" sm="12" md="12" lg="12" xl="12" xxl="12">
                        <MudTextField T="string"
                                      Label="Dirección"
                                      Placeholder="Calle 1, #123"
                                      @bind-Value="BillToAddress"
                                      Immediate
                                      FullWidth Dense Margin="Margin.Dense"
                                      Variant="Variant.Outlined"
                                      Validation="ValidateAddress"
                                      InputAttributes="Address1Attrs" />
                      </MudItem>
                    </MudGrid>
                  </MudCardContent>
                </MudCard>

                <!-- Monto a cancelar (visual, solo tarjeta) -->

                  <div class="d-flex justify-center mt-4">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="3">
                      <MudText Typo="Typo.h6">Monto a cancelar</MudText>
                      <MudText Typo="Typo.subtitle1" Bold="true">@PayLabel</MudText>
                    </MudStack>
                  </div>

              </MudItem>
            </MudGrid>

            <!-- Hidden base que lee el SDK -->
            <input type="hidden" id="orderNumber" name="orderNumber" value="@OrderNumber" />
            <input type="hidden" id="amount"      name="amount"      value="@AmountString" />
            <input type="hidden" id="currency"    name="currency"    value="@Currency" />
            <input type="hidden" id="redirect"    name="redirect"    value="@RedirectUrl" />

            <!-- Contenedor del SDK -->
            <div id="responseTilopay" style="display:none"></div>

            @if (!string.IsNullOrWhiteSpace(Estado))
            {
              <MudAlert Severity="Severity.Info" Class="mt-3">@Estado</MudAlert>
            }

        </div>

      


      </MudCardContent>

      <!-- Botón abajo siempre -->
      <MudCardActions Class="sticky-actions d-flex justify-center">
        <MudButton Id="btnPagar"
                   Variant="Variant.Filled"
                   Color="Color.Info"
                   Disabled="@Pagando"
                   OnClick="Pagar"
                   Class="px-6 py-2">
          @(Pagando ? "Procesando…" : "Pagar")
        </MudButton>
      </MudCardActions>
    </MudCard>
  </MudItem>
</MudGrid>

<MudOverlay Visible="@ShowFailModal" DarkBackground="true">
    <MudPaper Elevation="12"
              Class="d-flex flex-column align-center justify-center"
              Style="width:min(640px,95vw); border-radius:20px; padding:48px 32px; text-align:center;">
        
        <MudIcon Icon="@Icons.Material.Filled.ReportGmailerrorred"
                 Size="Size.Large"
                 Color="Color.Error"
                 Class="mb-4" />

        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-2">
            Transacción no efectuada
        </MudText>

        <MudText Typo="Typo.subtitle2" Align="Align.Center" Class="mb-6">
            @(string.IsNullOrWhiteSpace(FailReason)
                ? "La transacción no pudo ser efectuada. Intente nuevamente."
                : FailReason)
        </MudText>

        <MudButton Variant="Variant.Filled"
                   Color="Color.Info"
                   OnClick="OnFailOk"
                   Class="px-6">
            OK
        </MudButton>
    </MudPaper>
</MudOverlay>




<style>
  .cc-input-pad input,
  .cc-input-pad .mud-input-input,
  .cc-input-pad .mud-input-slot{
    padding-right: 190px !important;   
  }
  .cc-brand{
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 12px;
    pointer-events: none;
  }

  .cc-logo{
    height: 32px !important;       
    display: inline-block;
    filter: grayscale(1);
    opacity: .28;
    transition: filter .15s, opacity .15s, transform .15s;
  }

  .cc-logo.active{
    filter: none;
    opacity: 1;
    transform: scale(1.05);
  }

.cc-brand{
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  display:flex;
  align-items:center;
  gap:12px;
  pointer-events:none;
}

.cc-brand{ top: calc(50% - 2px); }
.mud-input-error .cc-brand{ top: calc(50% - 4px); }
  
.sticky-actions {
  position: sticky;
  bottom: 0;
  background: var(--mud-palette-surface);
  padding: 12px 16px;
  z-index: 1;
}

.fullscreen-modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.65);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999999; 
}
.fullscreen-modal__content{
  background: var(--mud-palette-surface);
  color: var(--mud-palette-text-primary);
  padding: 24px 28px;
  border-radius: 16px;
  max-width: 520px;
  width: 92%;
  box-shadow: 0 10px 40px rgba(0,0,0,.35);
  text-align: center;
}

.fail-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.68);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 999999; 
}

.fail-card{
  background: var(--mud-palette-surface);
  color: var(--mud-palette-text-primary);
  width: min(520px, 92vw);
  padding: 28px 24px;
  border-radius: 16px;
  box-shadow: 0 16px 48px rgba(0,0,0,.35);
  text-align: center;
}

.fail-icon{
  display:flex; align-items:center; justify-content:center;
  width:64px; height:64px; margin:0 auto 12px auto;
  border-radius:50%;
  background: var(--mud-palette-error);
  color: white;
}

</style>

